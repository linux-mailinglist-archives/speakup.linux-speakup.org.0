Return-Path: <speakup-bounces@linux-speakup.org>
X-Original-To: lists+speakup@lfdr.de
Delivered-To: lists+speakup@lfdr.de
Received: from befuddled.reisers.ca (befuddled.reisers.ca [206.248.184.127])
	by mail.lfdr.de (Postfix) with ESMTP id 7190C2AAAA5
	for <lists+speakup@lfdr.de>; Sun,  8 Nov 2020 12:15:58 +0100 (CET)
Received: by befuddled.reisers.ca (Postfix, from userid 65534)
	id B6DF7380EF0; Sun,  8 Nov 2020 06:15:57 -0500 (EST)
Received: from befuddled.reisers.ca (localhost [IPv6:::1])
	by befuddled.reisers.ca (Postfix) with ESMTP id 860FB380ECD;
	Sun,  8 Nov 2020 06:15:56 -0500 (EST)
X-Original-To: speakup@linux-speakup.org
Delivered-To: speakup@linux-speakup.org
Received: by befuddled.reisers.ca (Postfix, from userid 65534)
 id 4612E380B40; Sun,  8 Nov 2020 06:15:55 -0500 (EST)
Received: from covici.com (debian-2.covici.com [166.84.7.93])
 by befuddled.reisers.ca (Postfix) with ESMTPS id 24481380B1D
 for <speakup@linux-speakup.org>; Sun,  8 Nov 2020 06:15:55 -0500 (EST)
Received: from ccs.covici.com (ccs.covici.com [70.109.53.110])
 (authenticated bits=0)
 by covici.com (8.15.2/8.15.2/Debian-14~deb10u1) with ESMTPSA id 0A8BGV56001623
 (version=TLSv1.3 cipher=TLS_AES_256_GCM_SHA384 bits=256 verify=NOT);
 Sun, 8 Nov 2020 06:16:33 -0500
Received: from ccs.covici.com (localhost [127.0.0.1])
 by ccs.covici.com (8.15.2/8.15.2) with ESMTPS id 0A8BFl3G375344
 (version=TLSv1.3 cipher=TLS_AES_256_GCM_SHA384 bits=256 verify=NOT);
 Sun, 8 Nov 2020 06:15:47 -0500
Received: (from covici@localhost)
 by ccs.covici.com (8.15.2/8.15.2/Submit) id 0A8BFlRl375242;
 Sun, 8 Nov 2020 06:15:47 -0500
Date: Sun, 08 Nov 2020 06:15:46 -0500
Message-ID: <m37dqw2j6l.wl-covici@ccs.covici.com>
From: John Covici <covici@ccs.covici.com>
To: Samuel Thibault <samuel.thibault@ens-lyon.org>
Subject: Re: speakup crashes with kernel 5.4.69
In-Reply-To: <20201103204526.rzk6pkposq5wjo3w@function>
References: <m3o8l6sge6.wl-covici@ccs.covici.com>
 <20201101205909.zz2ihrr6zmucrfbq@function>
 <5123cc09-8314-7bb4-82dd-5511b53b3703@slint.fr>
 <20201101214000.u6al47enhggqputs@function>
 <20201102071203.GC8027@gregn.net>
 <m3v9eop2ks.wl-covici@ccs.covici.com>
 <20201102091016.kasjjmcc3yjpvu4d@function>
 <m3pn4up7q1.wl-covici@ccs.covici.com>
 <20201103204526.rzk6pkposq5wjo3w@function>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM/1.14.9 (=?ISO-8859-4?Q?Goj=F2?=) APEL/10.8 EasyPG/1.0.0 Emacs/26
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Organization: Covici Computer Systems
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
X-BeenThere: speakup@linux-speakup.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: "Speakup is a screen review system for Linux."
 <speakup.linux-speakup.org>
List-Unsubscribe: <http://linux-speakup.org/cgi-bin/mailman/options/speakup>, 
 <mailto:speakup-request@linux-speakup.org?subject=unsubscribe>
List-Archive: <http://linux-speakup.org/pipermail/speakup/>
List-Post: <mailto:speakup@linux-speakup.org>
List-Help: <mailto:speakup-request@linux-speakup.org?subject=help>
List-Subscribe: <http://linux-speakup.org/cgi-bin/mailman/listinfo/speakup>,
 <mailto:speakup-request@linux-speakup.org?subject=subscribe>
Reply-To: covici@ccs.covici.com, "Speakup is a screen review system for Linux."
 <speakup@linux-speakup.org>
Cc: "Speakup is a screen review system for Linux." <speakup@linux-speakup.org>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: speakup-bounces@linux-speakup.org
Sender: "Speakup" <speakup-bounces@linux-speakup.org>
X-Bogosity: Ham, tests=bogofilter, spamicity=0.000000, version=1.2.4

The new patch seems to work fine, after limited testing.  Thanks.

On Tue, 03 Nov 2020 15:45:26 -0500,
Samuel Thibault wrote:
> 
> [1  <text/plain; us-ascii (7bit)>]
> John Covici, le mar. 03 nov. 2020 14:21:10 -0500, a ecrit:
> > I am sorry to  report that your patch does not work, probably because
> > it references drivers/accessibility rather than staging.  If that is
> > the case, I could change it and try again, or let me know.
> 
> Ah, yes, sorry, that should rather be staging, here is a fixed patch.
> 
> Samuel
> [2 speakup_in_nowait <text/plain; us-ascii (7bit)>]
> speakup ttyio: Do not schedule() in ttyio_in_nowait
> 
> With the ltlk and spkout drivers, the index read function, i.e.
> in_nowait, is getting called from the read_all_doc mechanism, from
> the timer softirq:
> 
> Call Trace:
>  <IRQ>
>  dump_stack+0x71/0x98
>  dequeue_task_idle+0x1f/0x28
>  __schedule+0x167/0x5d6
>  ? trace_hardirqs_on+0x2e/0x3a
>  ? usleep_range+0x7f/0x7f
>  schedule+0x8a/0xae
>  schedule_timeout+0xb1/0xea
>  ? del_timer_sync+0x31/0x31
>  do_wait_for_common+0xba/0x12b
>  ? wake_up_q+0x45/0x45
>  wait_for_common+0x37/0x50
>  ttyio_in+0x2a/0x6b
>  spk_ttyio_in_nowait+0xc/0x13
>  spk_get_index_count+0x20/0x93
>  cursor_done+0x1c6/0x4c6
>  ? read_all_doc+0xb1/0xb1
>  call_timer_fn+0x89/0x140
>  run_timer_softirq+0x164/0x1a5
>  ? read_all_doc+0xb1/0xb1
>  ? hrtimer_forward+0x7b/0x87
>  ? timerqueue_add+0x62/0x68
>  ? enqueue_hrtimer+0x95/0x9f
>  __do_softirq+0x181/0x31f
>  irq_exit+0x6a/0x86
> smp_apic_timer_interrupt+0x15e/0x183
>  apic_timer_interrupt+0xf/0x20
>  </IRQ>
> 
> We thus should not schedule() at all, even with timeout == 0, this
> crashes the kernel.  We can however use try_wait_for_completion()
> instead of wait_for_completion_timeout(0).
> 
> Cc: stable@vger.kernel.org
> Signed-off-by: Samuel Thibault <samuel.thibault@ens-lyon.org>
> Reported-by: John Covici <covici@ccs.covici.com>
> TODO Tested-by: John Covici <covici@ccs.covici.com>
> 
> ---
>  drivers/staging/speakup/spk_ttyio.c |   10 ++++++----
>  1 file changed, 6 insertions(+), 4 deletions(-)
> 
> --- a/drivers/staging/speakup/spk_ttyio.c
> +++ b/drivers/staging/speakup/spk_ttyio.c
> @@ -298,11 +298,13 @@ static unsigned char ttyio_in(int timeou
>  	struct spk_ldisc_data *ldisc_data = speakup_tty->disc_data;
>  	char rv;
>  
> -	if (wait_for_completion_timeout(&ldisc_data->completion,
> +	if (!timeout) {
> +		if (!try_wait_for_completion(&ldisc_data->completion))
> +			return 0xff;
> +	} else if (wait_for_completion_timeout(&ldisc_data->completion,
>  					usecs_to_jiffies(timeout)) == 0) {
> -		if (timeout)
> -			pr_warn("spk_ttyio: timeout (%d)  while waiting for input\n",
> -				timeout);
> +		pr_warn("spk_ttyio: timeout (%d)  while waiting for input\n",
> +			timeout);
>  		return 0xff;
>  	}
>  

-- 
Your life is like a penny.  You're going to lose it.  The question is:
How do
you spend it?

         John Covici wb2una
         covici@ccs.covici.com
_______________________________________________
Speakup mailing list
Speakup@linux-speakup.org
http://linux-speakup.org/cgi-bin/mailman/listinfo/speakup
